CA_EventPopUp_CMP -->

<!--
* @author : Urvashi Barapatre | APJ Call Automation FOR JAPAN
* @description : Call Planning Modal for Positive/Negative Account datatable
* @date : 22-03-2022
* Copyright (c) $2022 Johnson & Johnson
-->
<aura:component controller="CA_DatableClass" 
                implements="force:appHostable,flexipage:availableForAllPageTypes,flexipage:availableForRecordHome,force:hasRecordId,lightning:availableForFlowScreens" 
                access="global">
    <aura:attribute name="callPlannerList" type="object"/>
    <aura:attribute name="mycolumns" type="List"/>
    <aura:attribute name="sortedBy" type="boolean" default="Schedule_Flag_Disable__c"/>
    <aura:attribute name="sortedDirection" type="String" default="asc"/>
    <aura:attribute name="openModal" type="boolean"/>
    <aura:attribute name="selectesRec" type="Call_Plan_Data__c"/>
    <aura:attribute name="selectesRec1" type="Contact"/>
    <aura:attribute name="evtSubject" type="String" default=""/>
    <aura:attribute name="ConId" type="String" default=""/>
    <aura:attribute name="objectAPIName" type="string" default=""/>
    <aura:attribute name="evtStart" type="DateTime"/>
    <aura:attribute name="evtend" type="DateTime"/>
    <aura:attribute name="evtType" type="String"/>
    <aura:attribute name="eventRec" type="Event"/>
    <aura:attribute name="fieldMap" type="Map"/>
    <aura:attribute name="availDTP1Val" type="string"/>
    <aura:attribute name="availDTP2Val" type="string"/>
    <aura:handler name="init" value="{!this}" action="{!c.doInit}"/>
    
    <!--Declare Other topics Attributes-->
    <aura:attribute name="GenreList" type="List" default="[]" description="Genre Picklist Values"/>
    <aura:attribute name="selectedGenreList" type="List" default="[]" description="Selected Genre Picklist Values"/>
    
    
    <aura:attribute name="selectedLookUpRecord" type="sObject" default="{}"/>
    <aura:attribute name="selectedAccountContacts" type="sObject" default="{}"/>
    <aura:attribute name="dateValidationError" type="boolean" />
    <aura:attribute name="dateValidationError1" type="boolean" />
    
    <!-- Declare Contact Lookup Attributes-->
    <aura:attribute name="contactId" type="Id" default=""/>
    <aura:handler name="oSelectedRecordEvent" event="c:CA_EventcustomLookup" action="{!c.handleComponentEvent}"/>
    
    <aura:if isTrue="{!v.openModal}">
  <div class="slds-m-around_xx-large">
     
            <!--Use aura:if tag to display/hide popup based on isModalOpen value-->                         
            <!-- Modal/Popup Box starts here-->
            <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-01" aria-modal="true" aria-describedby="modal-content-id-1" class="slds-modal slds-fade-in-open slds-modal_small">
                <div class="slds-modal__container">
                    <div class="slds-scrollable_y"  >
                        <!--loading spinner start-->
                        <div class="slds-is-relative">
                            <aura:if isTrue="{!v.spinner}">
                                <div aura:id="spinnerId" class="slds-spinner_container">
                                    <div class="slds-spinner--brand  slds-spinner slds-spinner--medium slds-is-relative" role="alert">
                                        <span class="slds-assistive-text">Loading</span>
                                        <div class="slds-spinner__dot-a"></div>
                                        <div class="slds-spinner__dot-b"></div>
                                    </div>
                                </div>
                            </aura:if>
                            
                            <!--Loading spinner end--> 
                            
                            <!-- Code -->
                             <lightning:card>
                                <div class="slds-p-around_small">
                                    <header class="slds-modal__header">
                                        <strong><h1 id="modal-heading-01" class="color">New Event</h1></strong>
                                    </header>
                                     Modal -----{!v.selectesRec}
                                    <div class="slds-grid slds-gutters slds-p-top_x-small slds-p-bottom_x-small">
                                        <div class="slds-col slds-size_6-of-12">
                                            <span>
                                                <!--Subject-->
                                                <lightning:input aura:id="fieldId" name="evtSubject" label="Subject"  value="{!v.evtSubject}" fieldLabel="Subject"/>
                                            </span>
                                        </div>
                                        <div class="slds-col slds-size_6-of-12">
                                            <span>
                                                <!-- Picklist Event type-->
                                                <div class="form-group">
                                                    <lightning:select aura:id="validate" value="{!v.evtType}" name="industryPicklist" 
                                                                      label="Event Type" messageWhenValueMissing="Event Type is Mandatory" required="true">
                                                        <option value="">--None--</option>
                                                        <aura:iteration items="{!v.fieldMap}" var="i" indexVar="key">
                                                            <option text="{!i.value}" value="{!i.key}" selected="{!i.key==v.evtType}" />
                                                        </aura:iteration>
                                                    </lightning:select>
                                                </div>
                                                <!-- Picklist Event type-->
                                            </span>
                                        </div>
                                    </div>
                                    <div class="slds-grid slds-gutters slds-p-top_x-small slds-p-bottom_x-small">
                                        <div class="slds-col slds-size_6-of-12">
                                            <span>
                                                <!--Start Datetime-->
                                                <lightning:input aura:id="validate" type="Datetime" name="evtStart" label="Start Date" value="{!v.evtStart}" 
                                                                 messageWhenValueMissing="Start Date is Mandatory" required="true"  onchange="{!c.StartdateUpdate}" 
                                                                 class="{! v.dateValidationError ? 'slds-has-error' : ''}"/>
                                                <aura:if isTrue="{!v.dateValidationError}">
                                                    <div class="slds-text-color_error slds-p-left_x-small">
                                                        Start Date must be in present or in future date.
                                                    </div>
                                                </aura:if>  
                                            </span>
                                        </div>
                                        <div class="slds-col slds-size_6-of-12">
                                            <span>
                                                <lightning:input aura:id="validate" type="Datetime" name="evtEnd" label="End Date" value="{!v.evtend}" 
                                                                 messageWhenValueMissing="End Date is Mandatory" required="true" onchange="{!c.EnddateUpdate}" 
                                                                 class="{! v.dateValidationError1 ? 'slds-has-error' : ''}"/>
                                                <aura:if isTrue="{!v.dateValidationError1}">
                                                    <div class="slds-text-color_error slds-p-left_x-small">
                                                        End Date should be greater than start date.
                                                    </div>
                                                </aura:if>  
                                            </span>
                                        </div>
                                    </div>
                                    <div class="slds-grid slds-gutters slds-p-top_x-small slds-p-bottom_x-small">
                                        <div class="slds-col slds-size_6-of-12">
                                            <span>
                                                <div class="slds-form-element__label">Account Name</div>
                                                <div class="slds-box slds-box_xx-small" style="{!v.selectesRec.Account_Name__c}">
                                                    <aura:if isTrue="{!v.selectesRec.Account_Name__c}">
                                                        <lightning:icon iconName="standard:account" size="small"></lightning:icon> &nbsp;&nbsp;
                                                        {!v.selectesRec.Account_Name__c}
                                                    </aura:if>
                                                </div>
                                            </span>
                                        </div>
                                        <div class="slds-col slds-size_6-of-12">
                                            <!--Lookup Contact-->
                                            <span>
                                                <c:CA_ParentComponent 
                                                                      objectAPIName="Contact" 
                                                                      IconName="standard:contact"
                                                                      ConId="{!v.ConId}"
                                                                      accountDetail="{!v.selectesRec.AccountId__c}"
                                                                      selectedRecord="{!v.selectedLookUpRecord}"
                                                                      label="Contact Name"
                                                                      />
                                            </span>
                                        </div>
                                        <!--Lookup Contact-->
                                    </div>
                                    <div class="slds-grid slds-gutters slds-p-top_x-small slds-p-bottom_x-small">
                                        <div class="slds-col slds-size_6-of-12">
                                            <span>
                                                <lightning:input aura:id="fieldId" label='Dr1' value="{!v.selectesRec.Available_Doctor_P1__c}"  />
                                            </span>
                                        </div>
                                        <div class="slds-col slds-size_6-of-12">
                                            <span>
                                                <lightning:input aura:id="fieldId" label='Dr2' value="{!v.selectesRec.Available_Doctor_P2__c}"  />
                                            </span>
                                        </div>
                                    </div>    
                                    <div class="slds-grid slds-gutters slds-p-top_x-small slds-p-bottom_x-small">
                                        <div class="slds-col slds-size_6-of-12">
                                            <span class='Span'>
                                                <div class="slds-form-element__label">Available Datetime1</div>
                                                <div class="slds-box slds-box_xx-small" style="{!v.availDTP1Val}"  name="datetime1">
                                                    <lightning:formattedRichText value="{!v.availDTP1Val}"/>
                                                    
                                                </div>
                                            </span>
                                        </div>
                                        <div class="slds-col slds-size_6-of-12">
                                            <span>
                                                <div class="slds-form-element__label">Available Datetime2</div>
                                                <div class="slds-box slds-box_xx-small" style="{!v.availDTP2Val}">
                                                    <lightning:formattedRichText value="{!v.availDTP2Val}" label="Available Datetime2"/>
                                                    
                                                </div>
                                            </span>
                                        </div>
                                    </div> 
                                    <lightning:dualListbox aura:id="selectGenre"
                                                           name="Genre"
                                                           label="Other Topics Covered"
                                                           options="{!v.GenreList }"
                                                           value="{!v.selectedGenreList}"
                                                           onchange="{!c.handleGenreChange}"/>
                                    
                                    <footer class="slds-modal__footer">
                                        <lightning:button iconName="utility:undo"
                                                          iconPosition="right"
                                                          variant="destructive-text" 
                                                          label="Cancel"
                                                          title="Cancel"
                                                          onclick="{! c.closeModal }"/>
                                        
                                        <lightning:button iconName="utility:send"
                                                          variant="destructive" 
                                                          label="Done"
                                                          title="Done"
                                                          onclick="{!c.saveRecord }"/>
                                    </footer>
                                </div>
                            </lightning:card>
                        </div>
                    </div>
                </div>
            </section>
            <div class="slds-backdrop slds-backdrop_open"></div>
        </div>
    </aura:if>
</aura:component>
****************************************************

({
    successShowtoast: function (cmp, event, helper)
    {
        let action = cmp.get("c.insertEvt");
        let test = cmp.get("v.selectedGenreList").join('; ');
        
        action.setParams({
            callPlanRec: JSON.stringify(cmp.get("v.selectesRec")),
            eventsub: cmp.get("v.evtSubject"),
            strtdate: cmp.get("v.evtStart"),
            enddate: cmp.get("v.evtend"),
            eventtype: cmp.get("v.evtType"),
            topics: test
        });
        action.setCallback(this, function (response) {
            let state = response.getState();
            let toastEvent = $A.get("e.force:showToast");
            if (state === "SUCCESS") 
            {
                toastEvent.setParams({
                    title: 'Success',
                    message: 'Event record has been created successfully.',
                    duration: ' 5000',
                    key: 'info_alt',
                    type: 'success',
                    mode: 'pester'
                });
                
                $A.get('e.force:refreshView').fire();
            } 
            else if (state === "ERROR") 
            {
                let errors = action.getError();
                toastEvent.setParams({
                    title: 'Error',
                    message: errors[0].message,
                    type: 'error'
                });
                $A.get('e.force:refreshView').fire();
            }
            toastEvent.fire();
        });
        $A.enqueueAction(action);
    },
    
    saveRecord: function (cmp, event, helper) 
    {
        /* 
         * custom validation for Event popup layout
        */
        let eventsfields = cmp.find("validate");
        let blank = 0;
        if (eventsfields.length != undefined) 
        {
            let allValid = eventsfields.reduce(function (validSoFar, inputCmp) {
                inputCmp.showHelpMessageIfInvalid();
                return validSoFar && inputCmp.get('v.validity').valid;
            }, true);
            if (!allValid) 
            {
                blank++;
            }
        } 
        else 
        {
            let allValid = eventsfields;
            if (!allValid.get('v.validity').valid)
            {
                blank++;
            }
        }
        /* 
         * custom validation for Contact Name from Event popup layout
        */
        let eventsfields1 = cmp.get('v.selectedLookUpRecord.Id');
        if (eventsfields1 == "" || eventsfields1 === undefined || !eventsfields1) 
        {
            let toastEvent = $A.get("e.force:showToast");
            toastEvent.setParams({
                title : 'Warning',
                message: 'Contact Name is Mandatory',
                key: 'info_alt',
                type: 'warning',
            });
            toastEvent.fire();
            return;
        }
        if (blank == 0) 
        {
            let successMethod =cmp.get('c.successShowtoast');
            $A.enqueueAction(successMethod);
        }
    },
    
    updateColumnSorting: function (cmp, event, helper)
    {
        let fieldName = event.getParam('fieldName');
        let sortDirection = event.getParam('sortDirection');
        cmp.set("v.sortedBy", fieldName);
        cmp.set("v.sortedDirection", sortDirection);
        helper.sortData(cmp, fieldName, sortDirection);
    },
    
    /* 
   	* Contact Lookup mapping on Event Popup layout
  	*/
    handleComponentEvent: function (cmp, event, helper) 
    {
        cmp.set("v.ConId", event.getParam("recordByEventRec"));
        let addNewVal = cmp.get('v.selectesRec');
        addNewVal['Doctor_Name__c'] = event.getParam("recordByEventRec").Id;
        let eventsfields1 = cmp.get('v.selectedLookUpRecord.Id');
        if (eventsfields1 === undefined || eventsfields1 == "" || !eventsfields1) 
        {
            return;
        }
        cmp.set('v.selectesRec', addNewVal);
    },
    
    handleRowAction: function (cmp, event, helper) 
    {
        //let row = event.getParam('row');
        let row = cmp.get('v.selectesRec');
        //cmp.set('v.selectesRec', row);
       //cmp.set(row,'v.selectesRec');
        console.log('Datetime alert',row.Doc1_Available_Datetime__c);
        cmp.set("v.openModal", true);
        
        /*
     	* Available Datetime1 Split Code
    	*/
      
    },
    
    closeModal: function (cmp, event, helper) 
    {
        cmp.set("v.openModal", false);
          // $A.get('e.force:refreshView').fire();
    },
    
    doInit: function (component, event, helper) 
    {
        let row = component.get('v.selectesRec');
        console.log('Datetime alert1',row.Doc1_Available_Datetime__c);
        component.set('v.accName', 'selectesRec.AccountId__c');
        if (row.Doc1_Available_Datetime__c != null) 
        {
            let splitVal1 = row.Doc1_Available_Datetime__c.replaceAll(" ", "<br/>");
            let splitVal01 = splitVal1.replace(/(<br\s*\/?>){2,}/gi, '<br>');
            component.set("v.availDTP1Val", splitVal01);
        }
        /*
     	* Available Datetime2 Split Code
    	*/
        if (row.Doc_2_Available_Datetime__c != null) 
        {
            let splitVal2 = row.Doc_2_Available_Datetime__c.replaceAll(" ", "<br/>");
            let splitVal01 = splitVal2.replace(/(<br\s*\/?>){2,}/gi, '<br>');
            component.set("v.availDTP2Val", splitVal01);
        }
        
        helper.getPicklistValues(component, event);
        helper.getTopicsValues(component, event);
        component.set('v.mycolumns', [
            {
                label: 'Action',
                type: 'button',
                typeAttributes:
                {
                    iconName: 'utility:view',
                    label: 'Schedule',
                    name: 'viewRecord',
                    disabled: false,
                    value: 'viewBtn',
                    variant: { fieldName: 'buttonColor' }
                },
                "initialWidth": 150
            },
            {
                label: 'Priority',
                fieldName: 'Priority__c',
                type: 'Number',
                sortable: true,
                "initialWidth": 150
            },
            {
                label: 'Account Name',
                fieldName: 'linkName',
                type: 'url',
                typeAttributes: {
                    label: { fieldName: 'Account_Name__c' },
                    target: '_blank'
                },
                "initialWidth": 150
            },
            {
                label: 'Last Call Date',
                fieldName: 'Last_Call_Date_Formula__c',
                type: 'text',
                sortable: true,
                "initialWidth": 150
            },
            {
                label: 'Completed Call of This Month',
                fieldName: 'Call_of_This_Month__c',
                type: 'Number',
                sortable: true,
                "initialWidth": 150
            },
            {
                label: 'Incoming Call of This Month',
                fieldName: 'Incoming_Call_of_This_Month__c',
                type: 'text',
                sortable: true,
                "initialWidth": 150
            },
            {
                label: 'Call Frequency',
                fieldName: 'Call_Frequency_Monthly__c',
                type: 'Number',
                sortable: true,
                "initialWidth": 150
            },
            {
                label: 'Target in 3 month',
                fieldName: 'Target_in_3_month__c',
                type: 'text',
                sortable: true,
                "initialWidth": 150
            },
            {
                label: 'Segment',
                fieldName: 'Cataract_Segment__c',
                type: 'text',
                sortable: true,
                "initialWidth": 150
            },
            {
                label: 'Procedures',
                fieldName: 'Medicare_Procedure__c',
                type: 'Number',
                sortable: true,
                "initialWidth": 150
            },
            {
                label: 'Predicted Potential(Monthly)',
                fieldName: 'Predicted_Account_fulfillment__c',
                type: 'Number',
                sortable: true,
                "initialWidth": 150
            },
            {
                label: 'Sales In Unit (Monthly)',
                fieldName: 'Account_Potential__c',
                type: 'Number',
                sortable: true,
                "initialWidth": 150
            },
            {
                label: 'Target month Sales plan unit',
                fieldName: 'Target_month_Sales_plan_unit__c',
                type: 'Number',
                sortable: true,
                "initialWidth": 150
            },
            {
                label: 'JnJ Share',
                fieldName: 'JNJ_IOL_share__c',
                type: 'Number',
                sortable: true,
                "initialWidth": 150
            },
            {
                label: 'Plan to use all JnJ Prod',
                fieldName: 'Plan_to_use_all_JnJ_Prod__c',
                type: 'text',
                sortable: true,
                "initialWidth": 150
            },
            {
                label: 'Dr1',
                fieldName: 'Available_Doctor_P1__c',
                type: 'text',
                sortable: true,
                "initialWidth": 150
            },
            {
                label: 'Available Datetime1',
                fieldName: 'Doc1_Available_Datetime__c',
                type: 'text',
                sortable: true,
                "initialWidth": 150
            },
            {
                label: 'Dr2',
                fieldName: 'Available_Doctor_P2__c',
                type: 'text',
                sortable: true,
                "initialWidth": 150
            },
            {
                label: 'Available Datetime2',
                fieldName: 'Doc_2_Available_Datetime__c',
                type: 'text',
                sortable: true,
                "initialWidth": 150
            },
            {
                label: 'Address',
                fieldName: 'Account_Addess__c',
                type: 'text',
                sortable: true,
                "initialWidth": 150
            }
            
        ]);
        helper.fetchPosAccounts(component);
    },
    
    /*
   	* handle other Topics covered multi-Picklist Selection on Event Popup Layout
  	*/
    handleGenreChange: function (component, event, helper) 
    {
        let selectedValues = component.get("v.selectedGenreList");
        component.set("v.selectedGenreList", selectedValues);
    },
    
    /*
   	* Event StartDateTime custom validation on Event Popup Layout
 	*/
    StartdateUpdate: function (component, event, helper)
    {
        let today = new Date();
        let dd = today.getDate();
        let mm = today.getMonth() + 1;
        let yyyy = today.getFullYear();
        if (dd < 10) 
        {
            dd = '0' + dd;
        }
        if (mm < 10)
        {
            mm = '0' + mm;
        }
        
        let todayFormattedDate = yyyy + '-' + mm + '-' + dd;
        if (component.get("v.evtStart") != '' && component.get("v.evtStart") < todayFormattedDate) 
        {
            component.set("v.dateValidationError", true);
        } 
        else 
        {
            component.set("v.dateValidationError", false);
        }
    },
    
    /*
     * Event EndDateTime custom validation on Event Popup Layout
    */
    EnddateUpdate: function (component, event, helper) 
    {
        
        let today = new Date();
        let dd = today.getDate();
        let mm = today.getMonth() + 1;
        let yyyy = today.getFullYear();
        if (dd < 10)
        {
            dd = '0' + dd;
        }
        if (mm < 10) 
        {
            mm = '0' + mm;
        }
        
        let todayFormattedDate = yyyy + '-' + mm + '-' + dd;
        if ((component.get("v.evtend") != '' && component.get("v.evtend") < todayFormattedDate) || component.get("v.evtend") <= component.get("v.evtStart")) 
        {
            component.set("v.dateValidationError1", true);
        } 
        else 
        {
            component.set("v.dateValidationError1", false);
        }
    }
});
*************************************

({
    sortData: function (cmp, fieldName, sortDirection) 
    {
        let data = cmp.get("v.callPlannerList");
        let reverse = sortDirection !== 'asc';
        data.sort(this.sortBy(fieldName, reverse));
        cmp.set("v.callPlannerList", data);
    },
    
    getPicklistValues: function (component, event)
    {
        let action = component.get("c.getEventtypeFieldValue");
        action.setCallback(this, function (response) {
            let state = response.getState();
            if (state === "SUCCESS") 
            {
                let result = response.getReturnValue();
                let fieldMap = [];
                for (let key in result)
                {
                    if (result.hasOwnProperty(key))
                    {
                    	fieldMap.push({
                        key: key,
                        value: result[key]
                    	});
                    }
                }
                component.set("v.fieldMap", fieldMap);
            } 
            else if (state === "ERROR") 
            {
                let errors = response.getError();
                if (errors) 
                {
                    if (errors[0] && errors[0].message) 
                    {
                        $A.log("Errors", errors);
                    }
                }
            }
        });
        $A.enqueueAction(action);
    },
    
    sortBy: function (field, reverse, primer)
    {
        let key = primer ? function (x) {
            return primer(x[field]);
        } : function (x) {
            return x[field];
        };
        reverse = !reverse ? 1 : -1;
        return function (a, b) {
            return a = key(a), b = key(b), reverse * ((a > b) - (b > a));
        };
    },
    
    fetchPosAccounts: function (component) 
    {
        let action = component.get("c.getCallPlannerRec");
        action.setParams({});
        action.setCallback(this, function (response) {
            let state = response.getState();
            if (state === "SUCCESS") 
            {
                let records = response.getReturnValue();
                component.set("v.callPlannerList", response.getReturnValue());
                records.forEach(function (record) {
                    record['linkName'] = '/lightning/r/Account/' + record['AccountId__c'] + '/view';
                });
                for (let i = 0; i < records.length; i++)
                {
                    if (records[i].Call_Target_Meet__c == 1)
                    {
                        records[i].buttonColor = 'destructive';
                    }
                    else 
                    {
                        records[i].buttonColor = 'destructive-text';
                    }
                }
                component.set("v.callPlannerList", records);
            } 
            else if (state === "ERROR") 
            {
                let errors = response.getError();
                if (errors)
                {
                    if (errors[0] && errors[0].message) 
                    {
                        $A.log("Errors", errors);
                    }
                }
            }
        });
        $A.enqueueAction(action);
    },
    
    getTopicsValues: function (component, event, helper)
    {
        let action = component.get("c.getPiklistValues");
        action.setCallback(this, function (response) {
            let state = response.getState();
            if (state === "SUCCESS")
            {
                let result = response.getReturnValue();
                let plValues = [];
                for (let i = 0; i < result.length; i++) 
                {
                    plValues.push({
                        label: result[i],
                        value: result[i]
                    });
                }
                component.set("v.GenreList", plValues);
            } 
            else if (state === "ERROR") 
            {
                let errors = response.getError();
                if (errors) 
                {
                    if (errors[0] && errors[0].message) 
                    {
                        $A.log("Errors", errors);
                    }
                }
            }
        });
        $A.enqueueAction(action);
    },
})
***************************************
CA_PositiveDatable------------>

<!--
* @author : Urvashi Barapatre | APJ Call Automation FOR JAPAN
* @description : Call Planning datatable for Positive Account
* @date : 22-02-2022
* Copyright (c) $2022 Johnson & Johnson
-->
<aura:component controller="CA_DatableClass" 
                implements="force:appHostable,flexipage:availableForAllPageTypes,flexipage:availableForRecordHome,force:hasRecordId,lightning:availableForFlowScreens" 
                access="global">
    <aura:attribute name="callPlannerList" type="object"/>
    <aura:attribute name="mycolumns" type="List"/>
    <aura:attribute name="sortedBy" type="boolean" default="Schedule_Flag_Disable__c"/>
    <aura:attribute name="sortedDirection" type="String" default="asc"/>
    <aura:attribute name="openModal" type="boolean" default="false"/>
    <aura:attribute name="selectesRec" type="Call_Plan_Data__c"/>
    <aura:attribute name="selectesRec1" type="Contact"/>
    <aura:attribute name="evtSubject" type="String" default=""/>
    <aura:attribute name="ConId" type="String" default=""/>
    <aura:attribute name="objectAPIName" type="string" default=""/>
    <aura:attribute name="evtStart" type="DateTime"/>
    <aura:attribute name="evtend" type="DateTime"/>
    <aura:attribute name="evtType" type="String"/>
    <aura:attribute name="eventRec" type="Event"/>
    <aura:attribute name="fieldMap" type="Map"/>
    <aura:attribute name="availDTP1Val" type="string"/>
    <aura:attribute name="availDTP2Val" type="string"/>
    <aura:handler name="init" value="{!this}" action="{!c.doInit}"/>
    
    <!--Declare Other topics Attributes-->
    <aura:attribute name="GenreList" type="List" default="[]" description="Genre Picklist Values"/>
    <aura:attribute name="selectedGenreList" type="List" default="[]" description="Selected Genre Picklist Values"/>
    
    
    <aura:attribute name="selectedLookUpRecord" type="sObject" default="{}"/>
    <aura:attribute name="selectedAccountContacts" type="sObject" default="{}"/>
    <aura:attribute name="dateValidationError" type="boolean" />
    <aura:attribute name="dateValidationError1" type="boolean" />
    
    <!-- Declare Contact Lookup Attributes-->
    <aura:attribute name="contactId" type="Id" default=""/>
    <aura:handler name="oSelectedRecordEvent" event="c:CA_EventcustomLookup" action="{!c.handleComponentEvent}"/>
    
    <!--Datatable Component start-->
    <div class="slds-card">
        <!--Header Start-->
        <div class="slds-card__header slds-grid">
            <header class="slds-media slds-media_center slds-has-flexi-truncate">
                <div class="slds-media__figure">
                    <lightning:Icon iconName="standard:call"  size="small" class="slds-icon slds-input__icon slds-input__icon_right " />
                </div>
                <div class="slds-media__body">
                    <h1>
                        <a href="javascript:void(0);" class="slds-card__header-link slds-truncate" title="Account List">
                            <span class="slds-text-heading_small">Call Planning for Positive Account</span>
                        </a>
                    </h1>
                </div>
            </header>           
        </div>
        <!--Header end-->
        <!--Datatable code Start-->
        <lightning:card >
            <lightning:datatable data="{!v.callPlannerList}" columns="{!v.mycolumns}" 
                                 keyField="id" hideCheckboxColumn="true"
                                 onsort="{!c.updateColumnSorting}"
                                 sortedBy="{!v.sortedBy}" sortedDirection="{!v.sortedDirection}"
                                 onrowaction="{!c.handleRowAction }" />
        </lightning:card>
        <!--Datatable code end-->
    </div>
    <!--Datatable Component end-->
    <!-- Start Modal Code-->
    <aura:if isTrue="{!v.openModal}">
        <c:CA_EventPopUp_CMP openModal='true' selectesRec ='{!v.selectesRec}'/>
    </aura:if>
    <!--End Modal code-->
    <!--Markup ends-->
</aura:component>
************************************************************

({
    successShowtoast: function (cmp, event, helper)
    {
        let action = cmp.get("c.insertEvt");
        let test = cmp.get("v.selectedGenreList").join('; ');
        
        action.setParams({
            callPlanRec: JSON.stringify(cmp.get("v.selectesRec")),
            eventsub: cmp.get("v.evtSubject"),
            strtdate: cmp.get("v.evtStart"),
            enddate: cmp.get("v.evtend"),
            eventtype: cmp.get("v.evtType"),
            topics: test
        });
        action.setCallback(this, function (response) {
            let state = response.getState();
            let toastEvent = $A.get("e.force:showToast");
            if (state === "SUCCESS") 
            {
                toastEvent.setParams({
                    title: 'Success',
                    message: 'Event record has been created successfully.',
                    duration: ' 5000',
                    key: 'info_alt',
                    type: 'success',
                    mode: 'pester'
                });
                
                $A.get('e.force:refreshView').fire();
            } 
            else if (state === "ERROR") 
            {
                let errors = action.getError();
                toastEvent.setParams({
                    title: 'Error',
                    message: errors[0].message,
                    type: 'error'
                });
                $A.get('e.force:refreshView').fire();
            }
            toastEvent.fire();
        });
        $A.enqueueAction(action);
    },
    
    saveRecord: function (cmp, event, helper) 
    {
        /* 
         * custom validation for Event popup layout
        */
        let eventsfields = cmp.find("validate");
        let blank = 0;
        if (eventsfields.length != undefined) 
        {
            let allValid = eventsfields.reduce(function (validSoFar, inputCmp) {
                inputCmp.showHelpMessageIfInvalid();
                return validSoFar && inputCmp.get('v.validity').valid;
            }, true);
            if (!allValid) 
            {
                blank++;
            }
        } 
        else 
        {
            let allValid = eventsfields;
            if (!allValid.get('v.validity').valid)
            {
                blank++;
            }
        }
        /* 
         * custom validation for Contact Name from Event popup layout
        */
        let eventsfields1 = cmp.get('v.selectedLookUpRecord.Id');
        if (eventsfields1 == "" || eventsfields1 === undefined || !eventsfields1) 
        {
            let toastEvent = $A.get("e.force:showToast");
            toastEvent.setParams({
                title : 'Warning',
                message: 'Contact Name is Mandatory',
                key: 'info_alt',
                type: 'warning',
            });
            toastEvent.fire();
            return;
        }
        if (blank == 0) 
        {
            let successMethod =cmp.get('c.successShowtoast');
            $A.enqueueAction(successMethod);
        }
    },
    
    updateColumnSorting: function (cmp, event, helper)
    {
        let fieldName = event.getParam('fieldName');
        let sortDirection = event.getParam('sortDirection');
        cmp.set("v.sortedBy", fieldName);
        cmp.set("v.sortedDirection", sortDirection);
        helper.sortData(cmp, fieldName, sortDirection);
    },
    
    /* 
   	* Contact Lookup mapping on Event Popup layout
  	*/
    handleComponentEvent: function (cmp, event, helper) 
    {
        cmp.set("v.ConId", event.getParam("recordByEventRec"));
        let addNewVal = cmp.get('v.selectesRec');
        addNewVal['Doctor_Name__c'] = event.getParam("recordByEventRec").Id;
        let eventsfields1 = cmp.get('v.selectedLookUpRecord.Id');
        if (eventsfields1 === undefined || eventsfields1 == "" || !eventsfields1) 
        {
            return;
        }
        cmp.set('v.selectesRec', addNewVal);
    },
    
    handleRowAction: function (cmp, event, helper) 
    {
        let row = event.getParam('row');
        cmp.set('v.selectesRec', row);
        cmp.set("v.openModal", true);
        
        /*
     	* Available Datetime1 Split Code
    	*/
        if (row.Doc1_Available_Datetime__c != null) 
        {
            let splitVal1 = row.Doc1_Available_Datetime__c.replaceAll(" ", "<br/>");
            let splitVal01 = splitVal1.replace(/(<br\s*\/?>){2,}/gi, '<br>');
            cmp.set("v.availDTP1Val", splitVal01);
        }
        /*
     	* Available Datetime2 Split Code
    	*/
        if (row.Doc_2_Available_Datetime__c != null) 
        {
            let splitVal2 = row.Doc_2_Available_Datetime__c.replaceAll(" ", "<br/>");
            let splitVal01 = splitVal2.replace(/(<br\s*\/?>){2,}/gi, '<br>');
            cmp.set("v.availDTP2Val", splitVal01);
        }
    },
    
    closeModal: function (cmp, event, helper) 
    {
        cmp.set("v.openModal", false);
    },
    
    doInit: function (component, event, helper) 
    {
        component.set('v.accName', 'selectesRec.AccountId__c');
        
        helper.getPicklistValues(component, event);
        helper.getTopicsValues(component, event);
        component.set('v.mycolumns', [
            {
                label: 'Action',
                type: 'button',
                typeAttributes:
                {
                    iconName: 'utility:view',
                    label: 'Schedule',
                    name: 'viewRecord',
                    disabled: false,
                    value: 'viewBtn',
                    variant: { fieldName: 'buttonColor' }
                },
                "initialWidth": 150
            },
            {
                label: 'Priority',
                fieldName: 'Priority__c',
                type: 'Number',
                sortable: true,
                "initialWidth": 150
            },
            {
                label: 'Account Name',
                fieldName: 'linkName',
                type: 'url',
                typeAttributes: {
                    label: { fieldName: 'Account_Name__c' },
                    target: '_blank'
                },
                "initialWidth": 150
            },
            {
                label: 'Last Call Date',
                fieldName: 'Last_Call_Date_Formula__c',
                type: 'text',
                sortable: true,
                "initialWidth": 150
            },
            {
                label: 'Completed Call of This Month',
                fieldName: 'Call_of_This_Month__c',
                type: 'Number',
                sortable: true,
                "initialWidth": 150
            },
            {
                label: 'Incoming Call of This Month',
                fieldName: 'Incoming_Call_of_This_Month__c',
                type: 'text',
                sortable: true,
                "initialWidth": 150
            },
            {
                label: 'Call Frequency',
                fieldName: 'Call_Frequency_Monthly__c',
                type: 'Number',
                sortable: true,
                "initialWidth": 150
            },
            {
                label: 'Target in 3 month',
                fieldName: 'Target_in_3_month__c',
                type: 'text',
                sortable: true,
                "initialWidth": 150
            },
            {
                label: 'Segment',
                fieldName: 'Cataract_Segment__c',
                type: 'text',
                sortable: true,
                "initialWidth": 150
            },
            {
                label: 'Procedures',
                fieldName: 'Medicare_Procedure__c',
                type: 'Number',
                sortable: true,
                "initialWidth": 150
            },
            {
                label: 'Predicted Potential(Monthly)',
                fieldName: 'Predicted_Account_fulfillment__c',
                type: 'Number',
                sortable: true,
                "initialWidth": 150
            },
            {
                label: 'Sales In Unit (Monthly)',
                fieldName: 'Account_Potential__c',
                type: 'Number',
                sortable: true,
                "initialWidth": 150
            },
            {
                label: 'Target month Sales plan unit',
                fieldName: 'Target_month_Sales_plan_unit__c',
                type: 'Number',
                sortable: true,
                "initialWidth": 150
            },
            {
                label: 'JnJ Share',
                fieldName: 'JNJ_IOL_share__c',
                type: 'Number',
                sortable: true,
                "initialWidth": 150
            },
            {
                label: 'Plan to use all JnJ Prod',
                fieldName: 'Plan_to_use_all_JnJ_Prod__c',
                type: 'text',
                sortable: true,
                "initialWidth": 150
            },
            {
                label: 'Dr1',
                fieldName: 'Available_Doctor_P1__c',
                type: 'text',
                sortable: true,
                "initialWidth": 150
            },
            {
                label: 'Available Datetime1',
                fieldName: 'Doc1_Available_Datetime__c',
                type: 'text',
                sortable: true,
                "initialWidth": 150
            },
            {
                label: 'Dr2',
                fieldName: 'Available_Doctor_P2__c',
                type: 'text',
                sortable: true,
                "initialWidth": 150
            },
            {
                label: 'Available Datetime2',
                fieldName: 'Doc_2_Available_Datetime__c',
                type: 'text',
                sortable: true,
                "initialWidth": 150
            },
            {
                label: 'Address',
                fieldName: 'Account_Addess__c',
                type: 'text',
                sortable: true,
                "initialWidth": 150
            }
            
        ]);
        helper.fetchPosAccounts(component);
    },
    
    /*
   	* handle other Topics covered multi-Picklist Selection on Event Popup Layout
  	*/
    handleGenreChange: function (component, event, helper) 
    {
        let selectedValues = component.get("v.selectedGenreList");
        component.set("v.selectedGenreList", selectedValues);
    },
    
    /*
   	* Event StartDateTime custom validation on Event Popup Layout
 	*/
    StartdateUpdate: function (component, event, helper)
    {
        let today = new Date();
        let dd = today.getDate();
        let mm = today.getMonth() + 1;
        let yyyy = today.getFullYear();
        if (dd < 10) 
        {
            dd = '0' + dd;
        }
        if (mm < 10)
        {
            mm = '0' + mm;
        }
        
        let todayFormattedDate = yyyy + '-' + mm + '-' + dd;
        if (component.get("v.evtStart") != '' && component.get("v.evtStart") < todayFormattedDate) 
        {
            component.set("v.dateValidationError", true);
        } 
        else 
        {
            component.set("v.dateValidationError", false);
        }
    },
    
    /*
     * Event EndDateTime custom validation on Event Popup Layout
    */
    EnddateUpdate: function (component, event, helper) 
    {
        
        let today = new Date();
        let dd = today.getDate();
        let mm = today.getMonth() + 1;
        let yyyy = today.getFullYear();
        if (dd < 10)
        {
            dd = '0' + dd;
        }
        if (mm < 10) 
        {
            mm = '0' + mm;
        }
        
        let todayFormattedDate = yyyy + '-' + mm + '-' + dd;
        if ((component.get("v.evtend") != '' && component.get("v.evtend") < todayFormattedDate) || component.get("v.evtend") <= component.get("v.evtStart")) 
        {
            component.set("v.dateValidationError1", true);
        } 
        else 
        {
            component.set("v.dateValidationError1", false);
        }
    }
});
**************************
({
    sortData: function (cmp, fieldName, sortDirection) 
    {
        let data = cmp.get("v.callPlannerList");
        let reverse = sortDirection !== 'asc';
        data.sort(this.sortBy(fieldName, reverse));
        cmp.set("v.callPlannerList", data);
    },
    
    getPicklistValues: function (component, event)
    {
        let action = component.get("c.getEventtypeFieldValue");
        action.setCallback(this, function (response) {
            let state = response.getState();
            if (state === "SUCCESS") 
            {
                let result = response.getReturnValue();
                let fieldMap = [];
                for (let key in result)
                {
                    if (result.hasOwnProperty(key))
                    {
                    	fieldMap.push({
                        key: key,
                        value: result[key]
                    	});
                    }
                }
                component.set("v.fieldMap", fieldMap);
            } 
            else if (state === "ERROR") 
            {
                let errors = response.getError();
                if (errors) 
                {
                    if (errors[0] && errors[0].message) 
                    {
                        $A.log("Errors", errors);
                    }
                }
            }
        });
        $A.enqueueAction(action);
    },
    
    sortBy: function (field, reverse, primer)
    {
        let key = primer ? function (x) {
            return primer(x[field]);
        } : function (x) {
            return x[field];
        };
        reverse = !reverse ? 1 : -1;
        return function (a, b) {
            return a = key(a), b = key(b), reverse * ((a > b) - (b > a));
        };
    },
    
    fetchPosAccounts: function (component) 
    {
        let action = component.get("c.getCallPlannerRec");
        action.setParams({});
        action.setCallback(this, function (response) {
            let state = response.getState();
            if (state === "SUCCESS") 
            {
                let records = response.getReturnValue();
                component.set("v.callPlannerList", response.getReturnValue());
                records.forEach(function (record) {
                    record['linkName'] = '/lightning/r/Account/' + record['AccountId__c'] + '/view';
                });
                for (let i = 0; i < records.length; i++)
                {
                    if (records[i].Call_Target_Meet__c == 1)
                    {
                        records[i].buttonColor = 'destructive';
                    }
                    else 
                    {
                        records[i].buttonColor = 'destructive-text';
                    }
                }
                component.set("v.callPlannerList", records);
            } 
            else if (state === "ERROR") 
            {
                let errors = response.getError();
                if (errors)
                {
                    if (errors[0] && errors[0].message) 
                    {
                        $A.log("Errors", errors);
                    }
                }
            }
        });
        $A.enqueueAction(action);
    },
    
    getTopicsValues: function (component, event, helper)
    {
        let action = component.get("c.getPiklistValues");
        action.setCallback(this, function (response) {
            let state = response.getState();
            if (state === "SUCCESS")
            {
                let result = response.getReturnValue();
                let plValues = [];
                for (let i = 0; i < result.length; i++) 
                {
                    plValues.push({
                        label: result[i],
                        value: result[i]
                    });
                }
                component.set("v.GenreList", plValues);
            } 
            else if (state === "ERROR") 
            {
                let errors = response.getError();
                if (errors) 
                {
                    if (errors[0] && errors[0].message) 
                    {
                        $A.log("Errors", errors);
                    }
                }
            }
        });
        $A.enqueueAction(action);
    },
})
**********************************
.THIS .slds-leftpad{
	padding-left: 2rem;
}
.THIS .iconheight{
    top: 65%;
}

.THIS .leftspace input {
    padding-left:2rem;
}
.THIS .Span{
     height: 50px;
}
.THIS .slds-th__action{
    color: #B71C1C;
}
.THIS .color{
    color: #B71C1C;
}
***********************************